# Seedream 4.0 多模式图像生成页面需求文档

## 1. 文档信息
- **版本**：v1.0（草案）
- **创建日期**：2025-02-14
- **撰写人**：Codex 助手
- **适用范围**：`image-generate-demo` 项目新增多功能图像生成页面

## 2. 背景
该项目需要集成火山引擎 Ark 平台的 Seedream 4.0 图像生成模型（`doubao-seedream-4-0-250828`）。现阶段仅有简单示例页面，无法满足多模式能力验证及演示需求。目标是设计一个最小可用（MVP）但具备核心功能的页面，支持单图、组图、图生图、多参考图生图等模式切换，并在多图模式下实现流式输出体验。

## 3. 目标与成功标准
- **目标**：提供一个统一页面，兼容 Seedream 4.0 在 API 文档中描述的主要产图模式，能直观配置参数并展示结果。
- **成功标准**：
  - 支持至少四种模式：**文生单图**、**文生组图**、**图生图**、**多参考图生图**。
  - 模式切换后，参数表单根据模式自动调整。
  - 组图或多张生成时启用 `stream=true`，前端能逐张实时渲染返回的图片。
  - 请求和响应状态清晰可视，错误信息可读。
  - 页面具备最基础的可用性（可输入、可提交、可查看结果）。

## 4. 范围
- **包含**：页面交互、前端参数校验、HTTP 请求封装、流式响应处理、结果展示、基础错误与状态处理。
- **不包含**：后端代理服务、用户体系、复杂的历史记录管理、生产级鉴权与日志平台集成。

## 5. 非目标
- 不实现完整的账户体系或 API Key 管理，仅提供输入/存储 API Key 的最小能力。
- 不涵盖自动化测试与持续部署流程。

## 6. 用户角色与场景
1. **产品/研发同学**：验证 Seedream 4.0 不同模式的能力，快速调参。
2. **演示人员**：向潜在客户展示流式组图效果。

主要用户故事：
- 作为使用者，我可以在单图模式下输入提示词并生成一张图片。
- 作为使用者，我可以开启组图模式，看到每张图片在生成时实时出现。
- 作为使用者，我可以上传参考图，在图生图模式下获得改造后的图片。
- 作为使用者，我可以管理多张参考图，批量生成多张结果图，并在出现失败时看到对应错误提示。

## 7. 功能需求
### 7.1 模式管理
- 支持以下模式切换：`单图 (Text-to-Image)`、`组图 (Text-to-Images)`、`图生图 (Image-to-Image)`、`多参考图生图 (Images-to-Images)`。
- 以 Tab 或 Segmented Control 呈现，默认选中单图模式。
- 模式切换时，保留公共字段（如提示词）并清空该模式特有的字段（如参考图列表）。

### 7.2 参数表单
- **公共字段**：
  - API Key（可选地缓存于 localStorage，提交前校验非空）。
  - Prompt（必填，文本域）。
  - 图片尺寸 `size`（下拉，默认 `2K`，选项覆盖文档中常用尺寸：`512x512`、`1024x1024`、`1536x1536`、`2K`、`4K` 等）。
  - 是否添加水印 `watermark`（开关，默认开启）。
  - 返回格式 `response_format` 固定为 `url`（MVP 阶段不暴露给用户但在文档中标注）。
- **组图模式新增**：
  - 输出张数，控制 `sequential_image_generation_options.max_images`，范围 2-4，默认 3。
  - 组图模式下默认 `sequential_image_generation` 设置为 `auto`。
  - 流式输出开关，默认开启（对应 `stream=true`），允许关闭以回退到一次性返回。
- **图生图模式新增**：
  - 单张参考图上传区域（支持本地文件转为 base64/URL 或直接输入 URL）。
  - 若需要自动压缩/转存，记录为后续迭代。
  - `sequential_image_generation` 固定为 `disabled`。
- **多参考图生图模式新增**：
  - 最少 2 张、最多 4 张参考图上传或 URL 输入。
  - 输出张数同组图模式配置。
  - `sequential_image_generation` 默认 `auto`。

### 7.3 请求发起与状态
- 点击“生成”按钮后：
  - 收集参数映射 API 请求体（详见第 9 章）。
  - 禁用按钮直至请求结束或中断。
  - 当前请求状态显示（`准备中`、`请求中`、`流式接收中`、`完成`、`失败`）。
- 支持取消请求（中断流式连接），MVP 可留待迭代，但需在文档中标记为待确认项。

### 7.4 响应处理
- **单图/非流式**：等待返回，解析 `data` 数组，展示图片与尺寸。
- **组图/流式**：
  - 使用 Fetch + ReadableStream 解析 SSE/Chunk（参照文档中的流式响应示例）。
  - 每收到一张图片的 `data` 事件立即追加至结果区域。
  - 若某张图返回 `error` 对象，记录并继续等待下一张（符合文档说明）。
- 悬浮操作区提供下载、复制 URL 等基础操作。

### 7.5 错误与异常
- 请求失败时（HTTP 层或业务 error）显示错误码与 message。
- 对常见错误（401、429、500）提供人性化提示。
- 对流式过程中单张图片的失败，提示该张失败原因，并允许继续查看剩余图片。

## 8. 非功能需求
- **性能**：流式渲染时，界面保持 60fps，避免一次性渲染大体积 base64（使用 URL）。
- **兼容性**：支持现代桌面浏览器（Chrome／Edge 最新版）。移动端适配放入后续迭代。
- **可用性**：表单校验即时反馈；长任务展示加载骨架或进度提示。
- **可维护性**：组件化表单与结果区域，确保后续易于扩展新模式。

## 9. API 对接要求
- **Endpoint**：`POST https://ark.cn-beijing.volces.com/api/v3/images/generations`
- **必需 Header**：
  - `Content-Type: application/json`
  - `Authorization: Bearer <用户输入的 ARK_API_KEY>`
- **通用请求体字段**：
  - `model`: 固定为 `doubao-seedream-4-0-250828`
  - `prompt`: 来自用户输入
  - `size`: 表单选择
  - `watermark`: 表单选择
  - `response_format`: 固定 `url`
  - `stream`: 按模式策略设置（组图默认 true，其余模式允许用户选择但默认 false）
- **模式差异化字段**：
  - 单图：`sequential_image_generation: "disabled"`
  - 组图：`sequential_image_generation: "auto"`，`sequential_image_generation_options.max_images` 指定数量。
  - 图生图：`image` 字段为单个 URL 字符串或 Base64。
  - 多参考图生图：`image` 字段为字符串数组；其余同组图。
- **流式解析**：
  - 参考文档流式格式，处理事件类型 `data`，直到收到 `[DONE]`。
  - 每个数据块需解析 JSON，识别 `data`（成功）与 `error`（失败）。
  - 对 `usage` 信息在流式结束后集中展示。

## 10. 前端架构与状态管理
- 使用 Vue 3 组合式 API。
- 建议拆分以下组件：
  - `ModeSwitcher`：负责模式切换。
  - `ParameterForm`：根据模式渲染字段，输出标准化请求 Payload。
  - `ResultPanel`：接收流式/非流式响应数据，展示图片与状态。
  - `StreamLog`（可选）：展示流式日志与错误。
- 使用全局状态管理（`ref`/`reactive`）记录当前模式、表单数据、请求状态、响应列表。
- 对 API Key 等敏感数据仅保存在运行时内存或浏览器本地（需二次确认）。

## 11. 日志与监控
- 控制台输出每次请求的参数摘要与耗时（非生产环境）。
- 记录失败原因，便于排查。

## 12. 安全与合规
- API Key 不持久化到仓库；如允许本地缓存，需提示用户风险。
- 避免在页面中记录或暴露用户上传的图片 URL。
- 确保跨域请求使用 HTTPS。

## 13. 风险与待确认事项
1. 前端是否需要实现本地图片转托管（当前阶段假设后端或用户提供可访问 URL）。
2. 是否需要提供负向提示词、风格模板等高级参数（当前不做）。
3. 流式响应具体格式需结合真实示例调试，必要时补充解析工具。
4. 是否需要提供取消请求功能（建议列为增强项）。

## 14. 验收标准
- 在开发环境配置有效 API Key 后，可连续完成以下操作：
  1. 单图模式生成成功，返回图片 URL 并显示尺寸。
  2. 组图模式（开启流式）能够逐张展示，至少 2 张结果。
  3. 图生图模式上传参考图后生成结果图。
  4. 多参考图生图模式上传多张参考图，流式返回多张结果并能处理某张失败的情况。
- 所有必填字段缺失时，有明确校验提示。
- 错误信息在 UI 中可见且指向具体问题。

